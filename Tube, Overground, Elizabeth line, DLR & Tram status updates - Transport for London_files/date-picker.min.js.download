(function(o) {
    "use strict";
    tfl.logs.create("tfl.datePicker: loaded");
    o.init = function() {
        tfl.logs.create("tfl.datePicker: initialised");
        o.highlightCalendarDays();
        $(window).on("calendar-next-month calendar-previous-month", o.highlightCalendarDays);
    };
    function makeDate(day, month, year) {
        var date = new Date();
        if (day) {
            date.setDate(day);
        }
        if (month) {
            date.setMonth(month - 1);
        }
        if (year) {
            date.setYear(year);
        }
        return date;
    }
    function removeParam(key, sourceURL) {
        var rtn = sourceURL.split("?")[0], param, params = [], queryString = sourceURL.indexOf("?") !== -1 ? sourceURL.split("?")[1] : "";
        if (queryString !== "") {
            params = queryString.split("&");
            if (params.length > 0) {
                for (var i = params.length - 1; i >= 0; i -= 1) {
                    param = params[i].split("=")[0];
                    if (param === key) {
                        params.splice(i, 1);
                    }
                }
                rtn = rtn + "?" + params.join("&");
            }
        }
        return rtn;
    }
    function addLeadingZero(numStr) {
        return numStr.length == 1 ? "0" + numStr : numStr;
    }
    o.highlightCalendarDays = function() {
        var $calendarContainer = $(".fc-calendar-container");
        var month = $calendarContainer.attr("data-month");
        var year = $calendarContainer.attr("data-year");
        var displayedCalendarMonth = makeDate(1, month, year);
        var $dateLinkContainer = $(".date-link-container");
        var currentDate = makeDate($dateLinkContainer.attr("data-current-day"), $dateLinkContainer.attr("data-current-month"), $dateLinkContainer.attr("data-current-year"));
        var $selectedDate = $(".date-link .selected-date");
        var selectedDay = $selectedDate.attr("data-selected-day");
        var selectedMonth = $selectedDate.attr("data-selected-month");
        var selectedYear = $selectedDate.attr("data-selected-year");
        if (displayedCalendarMonth <= currentDate) {
            $(".calendar-previous-month").addClass("disabled");
        } else {
            $(".calendar-previous-month").removeClass("disabled");
        }
        if (tfl.tools.getYearDiffBetweenDates(currentDate, new Date(displayedCalendarMonth.setMonth(displayedCalendarMonth.getMonth() + 1))) > 4) {
            $(".calendar-next-month").addClass("disabled");
        } else {
            $(".calendar-next-month").removeClass("disabled");
        }
        var tab = $(".date-wrap a"), input = tab.data("input"), lineIds = tab.data("lineids"), direction = tab.data("direction"), dateTypeSelect = tab.text(), calendarioDays = $calendarContainer.find(".fc-date"), iDate = makeDate(null, month, year);
        selectedMonth = addLeadingZero(selectedMonth);
        month = addLeadingZero(month);
        var href = $dateLinkContainer.attr("data-href");
        var isStatusUpdates = $dateLinkContainer.parents("ul").hasClass("status-updates");
        if (isStatusUpdates) {
            href = href.replace("This+weekend", "Future date").replace("Later+today", "Future date").replace("Now", "Future date");
        }
        href = removeParam("dateTypeSelect", removeParam("Input", removeParam("lineIds", removeParam("direction", removeParam("startDate", removeParam("endDate", href))))));
        if (href.indexOf("?") < 0) {
            href += "?";
        } else {
            href += "&";
        }
        href = href.replace("?&", "?");
        var lowerRangeValue = 2;
        var higherRangeValue = 5;
        for (var i = 0; i < calendarioDays.length; i++) {
            var $calendarioDay = $(calendarioDays[i]);
            iDate.setDate(i + 1);
            var dayText = $calendarioDay.text();
            if (selectedYear == year && selectedMonth == month && selectedDay == dayText) {
                $calendarioDay.parent().addClass("fc-today");
            } else if (iDate > currentDate && tfl.tools.isInDateRangeOrNull(iDate, lowerRangeValue, higherRangeValue)) {
                var day = addLeadingZero(dayText);
                var ymd = year + "-" + month + "-" + day;
                var data = {
                    href: href,
                    input: input,
                    lineIds: lineIds,
                    direction: direction,
                    date: ymd
                };
                var linkCalendarioDay = hoganTemplates.calendarioLink.render(data);
                $calendarioDay.wrap(linkCalendarioDay).parent().parent().addClass("highlighted-day");
            }
        }
    };
})(window.tfl.datePicker = window.tfl.datePicker || {});